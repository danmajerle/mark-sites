<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Denver Housing Pipeline</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>
  <main class="container">
    <header>
      <div class="brand">Denver Housing Pipeline</div>
      <div class="tag">Real v1 data pipeline · permit-derived development tracker</div>
    </header>

    <section class="hero">
      <h1>Track new housing delivery in Denver, with unit counts and project status.</h1>
      <p>v1 is powered by City and County of Denver residential construction permit data and rolled up to project-level records.
      It’s intentionally opinionated and transparent about assumptions.</p>
    </section>

    <section class="kpis">
      <article class="kpi"><div class="label">Projects tracked</div><div class="value" id="kpiProjects">—</div></article>
      <article class="kpi"><div class="label">Pipeline units</div><div class="value" id="kpiUnits">—</div></article>
      <article class="kpi"><div class="label">Under construction units</div><div class="value" id="kpiUC">—</div></article>
      <article class="kpi"><div class="label">Delivered units</div><div class="value" id="kpiDelivered">—</div></article>
    </section>

    <section class="panel" style="padding:12px; margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <input id="search" placeholder="Search project / address / neighborhood" style="flex:1; min-width:220px; padding:10px; border:1px solid var(--line); border-radius:10px;" />
      <select id="statusFilter" style="padding:10px; border:1px solid var(--line); border-radius:10px;">
        <option value="All">All statuses</option>
        <option>Proposed</option>
        <option>Approved</option>
        <option>Under Construction</option>
        <option>Delivered</option>
        <option>Cancelled</option>
      </select>
    </section>

    <section class="panel" style="padding:0; margin-bottom:10px; overflow:hidden;">
      <div id="map" style="height:380px; width:100%;"></div>
    </section>

    <section class="panel table-wrap">
      <table>
        <thead>
          <tr>
            <th data-sort="project_name" data-label="Project" style="cursor:pointer;">Project ↕</th>
            <th data-sort="neighborhood" data-label="Neighborhood" style="cursor:pointer;">Neighborhood ↕</th>
            <th data-sort="status" data-label="Status" style="cursor:pointer;">Status ↕</th>
            <th data-sort="units_total" data-label="Units" style="cursor:pointer;">Units ↕</th>
            <th data-sort="permit_count" data-label="Permits" style="cursor:pointer;">Permits ↕</th>
            <th data-sort="last_date_issued" data-label="Last permit date" style="cursor:pointer;">Last permit date ↕</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>

    <footer id="footerNote">Loading…</footer>
  </main>

  <script src="data.v1.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const payload = window.DENVER_HOUSING_V1 || {kpis:{}, developments:[]};
    const data = payload.developments || [];

    const fmt = n => Number(n || 0).toLocaleString();

    document.getElementById('kpiProjects').textContent = fmt(payload.kpis.projects_tracked || data.length);
    document.getElementById('kpiUnits').textContent = fmt(payload.kpis.pipeline_units);
    document.getElementById('kpiUC').textContent = fmt(payload.kpis.under_construction_units);
    document.getElementById('kpiDelivered').textContent = fmt(payload.kpis.delivered_units);

    document.getElementById('footerNote').innerHTML = `Updated: ${payload.kpis.updated_at || '—'} · Source: <code>${payload.kpis.source || '—'}</code>`;

    const classFor = s => ({
      'Proposed':'proposed',
      'Approved':'approved',
      'Under Construction':'uc',
      'Delivered':'delivered',
      'Cancelled':'delivered'
    }[s] || 'proposed');

    const rowsEl = document.getElementById('rows');
    const searchEl = document.getElementById('search');
    const statusEl = document.getElementById('statusFilter');
    const sortableHeaders = document.querySelectorAll('th[data-sort]');

    const map = L.map('map').setView([39.7392, -104.9903], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markerLayer = L.layerGroup().addTo(map);

    let sortKey = 'units_total';
    let sortDir = 'desc';

    function cmp(a, b, key) {
      const av = a?.[key];
      const bv = b?.[key];

      const numKeys = new Set(['units_total', 'permit_count']);
      const dateKeys = new Set(['last_date_issued']);

      if (numKeys.has(key)) {
        return Number(av || 0) - Number(bv || 0);
      }

      if (dateKeys.has(key)) {
        const ad = String(av || a?.last_final_date || a?.first_date_received || '');
        const bd = String(bv || b?.last_final_date || b?.first_date_received || '');
        return ad.localeCompare(bd);
      }

      return String(av || '').localeCompare(String(bv || ''));
    }

    function render() {
      const q = (searchEl.value || '').toLowerCase().trim();
      const status = statusEl.value;

      let filtered = data.filter(d => {
        const hit = !q || [d.project_name, d.address, d.neighborhood].join(' ').toLowerCase().includes(q);
        const statusHit = status === 'All' || d.status === status;
        return hit && statusHit;
      });

      filtered = filtered.sort((a, b) => {
        const primary = cmp(a, b, sortKey);
        const signed = sortDir === 'asc' ? primary : -primary;
        if (signed !== 0) return signed;
        return Number(b.units_total || 0) - Number(a.units_total || 0);
      });

      markerLayer.clearLayers();
      const mappable = filtered.filter(d => Number.isFinite(Number(d.latitude)) && Number.isFinite(Number(d.longitude))).slice(0, 1200);
      const latlngs = [];
      mappable.forEach(d => {
        const ll = [Number(d.latitude), Number(d.longitude)];
        latlngs.push(ll);
        const marker = L.circleMarker(ll, {
          radius: 4,
          weight: 1,
          fillOpacity: 0.7
        });
        marker.bindPopup(`<strong>${d.project_name || 'Project'}</strong><br>${d.address || ''}<br>Status: ${d.status || '—'}<br>Units: ${fmt(d.units_total)}`);
        marker.addTo(markerLayer);
      });
      if (latlngs.length > 2) {
        map.fitBounds(latlngs, {padding: [20, 20], maxZoom: 13});
      }

      rowsEl.innerHTML = filtered.slice(0, 500).map(d => `
        <tr>
          <td><strong>${d.project_name || '—'}</strong><br><span style="color:var(--muted)">${d.address || ''}</span></td>
          <td>${d.neighborhood || '—'}</td>
          <td><span class="status ${classFor(d.status)}">${d.status || '—'}</span></td>
          <td>${fmt(d.units_total)}</td>
          <td>${fmt(d.permit_count)}</td>
          <td>${d.last_date_issued || d.last_final_date || d.first_date_received || '—'}</td>
          <td><a href="${d.source_url}" target="_blank" rel="noreferrer">link</a></td>
        </tr>
      `).join('');
    }

    function updateSortIndicators() {
      sortableHeaders.forEach(h => {
        const label = h.getAttribute('data-label') || h.textContent.replace(/[▲▼↕]/g,'').trim();
        const key = h.getAttribute('data-sort');
        if (key === sortKey) {
          h.textContent = `${label} ${sortDir === 'asc' ? '▲' : '▼'}`;
        } else {
          h.textContent = `${label} ↕`;
        }
      });
    }

    sortableHeaders.forEach(h => {
      h.addEventListener('click', () => {
        const key = h.getAttribute('data-sort');
        if (!key) return;
        if (sortKey === key) {
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          sortKey = key;
          sortDir = (key === 'units_total' || key === 'permit_count' || key === 'last_date_issued') ? 'desc' : 'asc';
        }
        updateSortIndicators();
        render();
      });
    });

    searchEl.addEventListener('input', render);
    statusEl.addEventListener('change', render);
    updateSortIndicators();
    render();
  </script>
</body>
</html>
